<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Citas - PetCare Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <!-- Header -->
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">üêæ</div>
                    <h1 class="text-xl font-bold text-emerald-400">PetCare Admin</h1>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm">Cerrar sesi√≥n</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Titulo y Acciones -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">üìÖ Gestionar Citas</h2>
            <button onclick="abrirModalCita()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 rounded font-semibold">+ Nueva Cita</button>
        </div>

        <!-- Filtros -->
        <div class="bg-slate-800 p-4 rounded-lg mb-6 border border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Fecha</label>
                    <input type="date" id="filtroFecha" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Estado</label>
                    <select id="filtroStatus" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                        <option value="">Todos</option>
                        <option value="Pr√≥xima">Pr√≥xima</option>
                        <option value="Completada">Completada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Servicio</label>
                    <input type="text" id="filtroServicio" placeholder="Ej: Consulta" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>
                <div class="flex items-end">
                    <button onclick="aplicarFiltros()" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded">Filtrar</button>
                </div>
            </div>
        </div>

        <!-- Tabla de Citas -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-700 border-b border-slate-600">
                        <tr>
                            <th class="px-4 py-3 text-left">Mascota</th>
                            <th class="px-4 py-3 text-left">Cliente</th>
                            <th class="px-4 py-3 text-left">Servicio</th>
                            <th class="px-4 py-3 text-left">Veterinario</th>
                            <th class="px-4 py-3 text-left">Fecha</th>
                            <th class="px-4 py-3 text-left">Hora</th>
                            <th class="px-4 py-3 text-left">Estado</th>
                            <th class="px-4 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCitas" class="divide-y divide-slate-700">
                        <tr class="bg-slate-800">
                            <td colspan="8" class="px-4 py-8 text-center text-slate-400">Cargando citas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Editar Cita -->
    <div id="modalEditarCita" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Editar Cita</h3>
            <form onsubmit="guardarCita(event)" class="space-y-4">
                <input type="hidden" id="editarCitaId">
                
                <div>
                    <label class="block text-sm font-medium mb-1">Servicio</label>
                    <input type="text" id="editarServicio" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Veterinario</label>
                    <input type="text" id="editarVeterinario" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">Fecha</label>
                        <input type="date" id="editarFecha" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Hora</label>
                        <input type="time" id="editarHora" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Motivo</label>
                    <textarea id="editarMotivo" rows="2" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Estado</label>
                    <select id="editarStatus" class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                        <option value="Pr√≥xima">Pr√≥xima</option>
                        <option value="Completada">Completada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>

                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded font-semibold">Guardar</button>
                    <button type="button" onclick="cerrarModal('modalEditarCita')" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nueva Cita -->
    <div id="modalNuevaCita" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Nueva Cita</h3>
            <form onsubmit="crearCita(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Mascota (ID)</label>
                    <input type="number" id="nuevaMascotaId" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Servicio</label>
                    <input type="text" id="nuevoServicio" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Veterinario</label>
                    <input type="text" id="nuevoVeterinario" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">Fecha</label>
                        <input type="date" id="nuevoFecha" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Hora</label>
                        <input type="time" id="nuevoHora" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Motivo</label>
                    <textarea id="nuevoMotivo" rows="2" required class="w-full px-3 py-2 bg-slate-700 rounded text-white border border-slate-600"></textarea>
                </div>

                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded font-semibold">Crear</button>
                    <button type="button" onclick="cerrarModal('modalNuevaCita')" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let citasActuales = [];
        const token = localStorage.getItem('authToken');

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function abrirModalCita() {
            document.getElementById('modalNuevaCita').classList.add('active');
        }

        function editarCita(id) {
            const cita = citasActuales.find(c => c.id === id);
            if (!cita) return;

            document.getElementById('editarCitaId').value = cita.id;
            document.getElementById('editarServicio').value = cita.servicio;
            document.getElementById('editarVeterinario').value = cita.veterinario;
            document.getElementById('editarFecha').value = cita.fecha;
            document.getElementById('editarHora').value = cita.hora;
            document.getElementById('editarMotivo').value = cita.motivo || '';
            document.getElementById('editarStatus').value = cita.status;

            document.getElementById('modalEditarCita').classList.add('active');
        }

        async function guardarCita(e) {
            e.preventDefault();
            const id = document.getElementById('editarCitaId').value;

            const datos = {
                servicio: document.getElementById('editarServicio').value,
                veterinario: document.getElementById('editarVeterinario').value,
                fecha: document.getElementById('editarFecha').value,
                hora: document.getElementById('editarHora').value,
                motivo: document.getElementById('editarMotivo').value,
                status: document.getElementById('editarStatus').value
            };

            try {
                const resp = await fetch(`http://127.0.0.1:8000/api/admin/citas/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                if (resp.ok) {
                    alert('‚úì Cita actualizada correctamente');
                    cerrarModal('modalEditarCita');
                    cargarCitas();
                } else {
                    alert('Error al actualizar la cita');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        async function crearCita(e) {
            e.preventDefault();

            const datos = {
                mascota_id: parseInt(document.getElementById('nuevaMascotaId').value),
                servicio: document.getElementById('nuevoServicio').value,
                veterinario: document.getElementById('nuevoVeterinario').value,
                fecha: document.getElementById('nuevoFecha').value,
                hora: document.getElementById('nuevoHora').value,
                motivo: document.getElementById('nuevoMotivo').value
            };

            try {
                const resp = await fetch('http://127.0.0.1:8000/api/citas', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                if (resp.ok) {
                    alert('‚úì Cita creada correctamente');
                    cerrarModal('modalNuevaCita');
                    document.querySelector('#modalNuevaCita form').reset();
                    cargarCitas();
                } else {
                    alert('Error al crear la cita');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        async function cancelarCita(id) {
            if (!confirm('¬øEst√°s seguro de que deseas cancelar esta cita?')) return;

            try {
                const resp = await fetch(`http://127.0.0.1:8000/api/admin/citas/${id}/cancelar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resp.ok) {
                    alert('‚úì Cita cancelada');
                    cargarCitas();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function completarCita(id) {
            try {
                const resp = await fetch(`http://127.0.0.1:8000/api/admin/citas/${id}/aceptar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resp.ok) {
                    alert('‚úì Cita aceptada');
                    cargarCitas();
                } else {
                    alert('Error al aceptar la cita');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function rechazarCita(id) {
            if (!confirm('¬øEst√°s seguro de que deseas rechazar esta cita?')) return;

            try {
                const resp = await fetch(`http://127.0.0.1:8000/api/admin/citas/${id}/rechazar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resp.ok) {
                    alert('‚úì Cita rechazada');
                    cargarCitas();
                } else {
                    alert('Error al rechazar la cita');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function aplicarFiltros() {
            const fecha = document.getElementById('filtroFecha').value;
            const status = document.getElementById('filtroStatus').value;
            const servicio = document.getElementById('filtroServicio').value;

            const datos = {};
            if (fecha) datos.fecha = fecha;
            if (status) datos.status = status;
            if (servicio) datos.servicio = servicio;

            try {
                const resp = await fetch('http://127.0.0.1:8000/api/admin/citas/filtrar', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                if (resp.ok) {
                    const result = await resp.json();
                    citasActuales = result.data || result;
                    mostrarCitas();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarCitas() {
            const tabla = document.getElementById('tablaCitas');
            tabla.innerHTML = '';

            if (citasActuales.length === 0) {
                tabla.innerHTML = '<tr class="bg-slate-800"><td colspan="8" class="px-4 py-8 text-center text-slate-400">No hay citas</td></tr>';
                return;
            }

            citasActuales.forEach(cita => {
                const statusColor = {
                    'Pr√≥xima': 'bg-blue-900 text-blue-200',
                    'Completada': 'bg-green-900 text-green-200',
                    'Cancelada': 'bg-red-900 text-red-200'
                }[cita.status] || 'bg-slate-700';

                const fila = document.createElement('tr');
                fila.className = 'bg-slate-800 hover:bg-slate-700 transition';
                fila.innerHTML = `
                    <td class="px-4 py-3">${cita.mascota?.nombre || 'N/A'}</td>
                    <td class="px-4 py-3">${cita.user?.name || 'N/A'}</td>
                    <td class="px-4 py-3">${cita.servicio?.nombre || cita.servicio || 'N/A'}</td>
                    <td class="px-4 py-3">${cita.veterinario?.nombre || cita.veterinario || 'N/A'}</td>
                    <td class="px-4 py-3">${new Date(cita.fecha).toLocaleDateString()}</td>
                    <td class="px-4 py-3">${cita.hora}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-sm font-semibold ${statusColor}">
                            ${cita.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center space-x-2">
                        ${cita.status === 'Pr√≥xima' ? `
                            <button onclick="completarCita(${cita.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">‚úì Aceptar</button>
                            <button onclick="rechazarCita(${cita.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">‚úï Rechazar</button>
                        ` : `
                            <button onclick="editarCita(${cita.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">‚úèÔ∏è Editar</button>
                            <button onclick="cancelarCita(${cita.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">‚úï Cancelar</button>
                        `}
                    </td>
                `;
                tabla.appendChild(fila);
            });
        }

        async function cargarCitas() {
            try {
                const resp = await fetch('http://127.0.0.1:8000/api/admin/citas', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (resp.ok) {
                    const result = await resp.json();
                    console.log('Respuesta API:', result);
                    
                    // Manejar la estructura correcta
                    if (result && result.data && Array.isArray(result.data)) {
                        citasActuales = result.data;
                    } else if (Array.isArray(result)) {
                        citasActuales = result;
                    } else {
                        citasActuales = [];
                    }
                    
                    mostrarCitas();
                } else {
                    console.error('Status:', resp.status);
                    document.getElementById('tablaCitas').innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-red-400">Error ' + resp.status + '</td></tr>';
                }
            } catch (error) {
                console.error('Error al cargar citas:', error);
                document.getElementById('tablaCitas').innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-red-400">Error de conexi√≥n</td></tr>';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }

        // Cargar citas al iniciar
        window.addEventListener('load', cargarCitas);
    </script>
</body>
</html>
